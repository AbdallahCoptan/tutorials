<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <title>Advanced workflows on sequential jobs management - UL HPC Tutorials</title>
  

  <link rel="shortcut icon" href="../../../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Advanced workflows on sequential jobs management";
    var mkdocs_page_input_path = "advanced/advanced_workflows/README.md";
    var mkdocs_page_url = "/advanced/advanced_workflows/README/";
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js"></script>
  <script src="../../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../../js/highlight.pack.js"></script>
  <script src="../../../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> UL HPC Tutorials</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../..">Home</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Basic Tutorials</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../../basic/getting_started/">Getting Started</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../../basic/sequential_jobs/">HPC workflow with sequential jobs</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../Debug/">Efficient Debugging</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Advanced Software Management</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../EasyBuild/">Easybuild</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../RESIF/">RESIF</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>MPI / Performance Evaluation</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../OSU_MicroBenchmarks/">OSU Micro-benchmarks</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../HPL/">High Performance Linpack (HPL)</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../HPCG/">High Performance Conjugate Gradient (HPCG)</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Mathematics</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../MATLAB1/README/">MATLAB</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../R/">R - statistical computing</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Bioinformatics</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../Bioinformatics/">Running bioinformatics software</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../Galaxy/">Galaxy</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Parallel Debuggers</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../Allinea/">Allinea</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../TotalView/">TotalView</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Virtualization</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../Vagrant/">Vagrant</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../vm5k/">Grid5000 - Automatic VM deployment with VM5K</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>CFD/MD/Chemistry</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../MultiPhysics/">Advanced Parallel execution</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Big Data</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../Spark/">Big Data Application Over Apache Spark</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Advanced topics</span></li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Advanced workflows on sequential jobs management</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#advanced-workflows-on-sequential-jobs-management">Advanced workflows on sequential jobs management</a></li>
                
            
                <li class="toctree-l3"><a href="#prerequisites">Prerequisites</a></li>
                
            
                <li class="toctree-l3"><a href="#intro">Intro</a></li>
                
            
                <li class="toctree-l3"><a href="#container">Container</a></li>
                
                    <li><a class="toctree-l4" href="#connect-the-the-cluster-access-node-and-set-up-the-environment-for-this-tutorial">Connect the the cluster access node, and set-up the environment for this tutorial</a></li>
                
                    <li><a class="toctree-l4" href="#exercise-1-useful-oar-features">Exercise 1: useful oar features</a></li>
                
                    <li><a class="toctree-l4" href="#exercise-2-best-effort-job">Exercise 2: Best effort job</a></li>
                
                    <li><a class="toctree-l4" href="#exercise-3-checkpointing">Exercise 3: Checkpointing</a></li>
                
            
                <li class="toctree-l3"><a href="#please-clean-your-files">Please, clean your files</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../advanced_scheduling/">Advanced scheduling with SLURM</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../Python/">Prototyping with Python</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../ReproducibleResearch/">Reproducible Research</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../../rtfd/">Documentation (RTFD)</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../../contributing/">Contributing</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../../contacts/">Contacts</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">UL HPC Tutorials</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>Advanced topics &raquo;</li>
        
      
    
    <li>Advanced workflows on sequential jobs management</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="advanced-workflows-on-sequential-jobs-management">Advanced workflows on sequential jobs management</h1>
<h1 id="prerequisites">Prerequisites</h1>
<p>Make sure you have followed the tutorial "Getting started" and "HPC workflow with sequential jobs".</p>
<h1 id="intro">Intro</h1>
<p>During this session, we will review various advanced features of OAR:</p>
<ul>
<li>Exercise 1: Advanced OAR features: container, array jobs</li>
<li>Exercise 2: Best effort jobs</li>
<li>Exercise 3: Checkpoint restart</li>
</ul>
<p>We will use the following github repositories:</p>
<ul>
<li><a href="https://github.com/ULHPC/launcher-scripts">ULHPC/launcher-scripts</a></li>
<li><a href="https://github.com/ULHPC/tutorials">ULHPC/tutorials</a></li>
</ul>
<h1 id="container">Container</h1>
<h2 id="connect-the-the-cluster-access-node-and-set-up-the-environment-for-this-tutorial">Connect the the cluster access node, and set-up the environment for this tutorial</h2>
<pre><code>(yourmachine)$&gt; ssh chaos-cluster
</code></pre>
<p>If your network connection is unstable, use <a href="http://www.mechanicalkeys.com/files/os/notes/tm.html">screen</a>:</p>
<pre><code>(access)$&gt; screen
</code></pre>
<p>We will use 2 directory:</p>
<ul>
<li><code>$HOME</code>: default home directory, <strong>backed up</strong>, maximum 50GB, for important files</li>
<li><code>$WORK</code>: work directory, <strong>non backed up</strong>, maximum 500GB</li>
</ul>
<p>Create a sub directory $WORK/PS2, and work inside it</p>
<pre><code>(access)$&gt; mkdir $WORK/PS6
(access)$&gt; cd $WORK/PS6
</code></pre>
<p>In the following parts, we will assume that you are working in this directory.</p>
<p>Clone the repositories <code>ULHPC/tutorials</code> and <code>ULHPC/launcher-scripts.git</code></p>
<pre><code>(access)$&gt; git clone https://github.com/ULHPC/launcher-scripts.git
(access)$&gt; git clone https://github.com/ULHPC/tutorials.git
</code></pre>
<h2 id="exercise-1-useful-oar-features">Exercise 1: useful oar features</h2>
<h3 id="container_1">Container</h3>
<p>With OAR, it is possible to execute jobs within another one.
This functionality is called <strong>container jobs</strong>.</p>
<p>It can be used to ensure you will have a pool of nodes in advance.
In example, if you want to create a container on the 29th of June, with 4 nodes, available during 10 hours</p>
<pre><code>oarsub -t container -r "2015-06-29 09:00:00" -l nodes=4,walltime=10:00:00
</code></pre>
<p>For testing purposes, you can create a small and short container with a passive job</p>
<pre><code>oarsub -t container -l nodes=2,walltime=0:30:00 "sleep 1800"
[ADMISSION RULE] Modify resource description with type constraints
OAR_JOB_ID=1428304
</code></pre>
<p>OAR gives you the job id of your container, you can submit jobs inside this container with the parameter <code>-t inner=&lt;container id&gt;</code></p>
<pre><code>oarsub -I -t inner=1428304
</code></pre>
<p>Note that an inner job can not be a reservation (ie. it cannot overlap the container reservation).</p>
<h3 id="array-job">Array job</h3>
<p>Let's create an array of 5 jobs. 
With an array, in one oarsub command, you can submit N sub jobs.</p>
<pre><code>oarsub --array 5 -n array_job_test -l /core=1 $WORK/PS6/tutorials/advanced/advanced_workflows/scripts/array_job.sh

OAR_JOB_ID=1430652
OAR_JOB_ID=1430653
OAR_JOB_ID=1430654
OAR_JOB_ID=1430655
OAR_JOB_ID=1430656
OAR_ARRAY_ID=1430652U
</code></pre>
<p>The command is started with the environment variable "OAR_ARRAY_INDEX".</p>
<p>Using this index, you can split your work load in N batches.</p>
<p>If you look at the output in the OAR stdout files, you should read something like that:</p>
<pre><code>cat OAR.array_job_test.*

hostname :  s-cluster1-13
OAR_JOB_NAME    : array_job_test
OAR_JOB_ID      : 1430652
OAR_ARRAY_ID    : 1430652
OAR_ARRAY_INDEX : 1
hostname :  s-cluster1-13
OAR_JOB_NAME    : array_job_test
OAR_JOB_ID      : 1430653
OAR_ARRAY_ID    : 1430652
OAR_ARRAY_INDEX : 2
hostname :  s-cluster1-13
OAR_JOB_NAME    : array_job_test
OAR_JOB_ID      : 1430654
OAR_ARRAY_ID    : 1430652
OAR_ARRAY_INDEX : 3
hostname :  s-cluster1-13
OAR_JOB_NAME    : array_job_test
OAR_JOB_ID      : 1430655
OAR_ARRAY_ID    : 1430652
OAR_ARRAY_INDEX : 4
hostname :  s-cluster1-13
OAR_JOB_NAME    : array_job_test
OAR_JOB_ID      : 1430656
OAR_ARRAY_ID    : 1430652
OAR_ARRAY_INDEX : 5
</code></pre>
<p>Note: array jobs can neither be Interactive (-I) nor a reservation (-r).</p>
<h2 id="exercise-2-best-effort-job">Exercise 2: Best effort job</h2>
<p>By default, your jobs end in the default queue meaning they have all equivalent priority. 
You can also decide to create so called best-effort jobs which are scheduled in the besteffort queue.
Their particularity is that they are deleted if another not besteffort job wants resources where they are running.</p>
<p>The main advantage is that besteffort jobs allows you to bypass the limit on the default queue (number of jobs and walltime).</p>
<p>In order to submit a besteffort job, you must append the parameter "-t besteffort" to your oarsub command.
Here is an example:</p>
<pre><code>oarsub -t besteffort /path/to/prog
</code></pre>
<p>The probability of your best effort job being killed increases with the walltime of the job.
We strongly advise to send best effort job with small walltimes (in example 2 hours), 
and just resubmit your job if it is killed.</p>
<p>You can do that automatically with the <code>idempotent</code> type.</p>
<pre><code>oarsub -t besteffort -t idempotent /path/to/prog
</code></pre>
<p>If your idempotent job is killed by the OAR scheduler, then another job is automatically 
created and scheduled with same configuration.
Additionally, your job is also resubmitted if the exit code of your program is 99.</p>
<p>Our best effort launcher script implements this mechanism.</p>
<p>We will now submit a besteffort job using the script <code>launcher_besteffort.sh</code>.
This job will execute a R script computing 130 Fibonacci numbers, 
note that the script sleep 2 seconds in each iteration in order to simulate a long running job.</p>
<p>Edit the file <code>$WORK/PS6/launcher-scripts/bash/besteffort/launcher_besteffort.sh</code></p>
<p>In the "Job settings" section, load R by adding this line:</p>
<pre><code>module load lang/R
</code></pre>
<p>Change the <code>$TASK</code> variable:</p>
<pre><code>TASK="Rscript $WORK/PS6/tutorials/advanced/advanced_workflows/scripts/test.R"
</code></pre>
<p>Now, submit the script on a specific node (choose a random free node)</p>
<pre><code>oarsub -t besteffort -t idempotent -l nodes=1 -p "network_address='h-cluster1-6'" $WORK/PS6/launcher-scripts/bash/besteffort/launcher_besteffort.sh

oarstat -u
</code></pre>
<p>Once the script is started, submit a normal interactive job on the same node, in order to force OAR to kill the besteffort job</p>
<pre><code>oarsub -I -l nodes=1 -p "network_address='h-cluster1-6'"

oarstat -u
</code></pre>
<p>Q: What do you observe ?</p>
<h2 id="exercise-3-checkpointing">Exercise 3: Checkpointing</h2>
<p><strong>Checkpointing</strong> is a technique which consists of storing a snapshot of the current application state,
in order to re-use it later for restarting the execution.
Checkpointing your jobs brings the following features:</p>
<ul>
<li>the job can overcome the limits of the default queue, especially the maximum walltime</li>
<li>fault tolerance, your job can survive even if the node crash</li>
</ul>
<p>You can implement a checkpointing mechanism yourself in your applications, or you can try with BLCR.
In all cases, your checkpointing mechanism must be chosen on a case by case basis, BLCR is not the only solution. 
Note that BLCR has some limitations, especially with sockets and network communication.</p>
<p>In this exercise, we will use BLCR with MATLAB.</p>
<p>BLCR can be used with 3 commands:</p>
<ul>
<li><code>cr_run</code> is a wrapper for your application</li>
<li><code>cr_checkpoint</code> will stop the application and save its state in a context file</li>
<li><code>cr_restart</code> will restart the application based on a context file</li>
</ul>
<h3 id="interactive-example-with-matlab">Interactive example with Matlab</h3>
<p>Create an interactive job, start a matlab program <code>cr_run</code></p>
<pre><code>(access) oarsub -I

(node) screen

(node) module load base/MATLAB
(node) export LIBCR_DISABLE_NSCD=YES
(node) cr_run matlab -nojvm -nodisplay -nosplash &lt;  $WORK/PS6/tutorials/advanced/advanced_workflows/scripts/test.m &amp;
</code></pre>
<p>Get the process id of matlab</p>
<pre><code>(node) echo $!
</code></pre>
<p>Create a new window inside your screen with "Ctrl-a c".</p>
<p>Look at the process table on the node</p>
<pre><code>(node) ps aux | grep MATLAB
</code></pre>
<p>Stop the matlab process and register its state in the file <code>/tmp/test.context</code></p>
<pre><code>(node) cr_checkpoint -f /tmp/test.context --kill -T &lt;Matlab process id&gt;
</code></pre>
<p>MATLAB should not be in the process table now</p>
<pre><code>(node) ps aux | grep MATLAB
</code></pre>
<p>Restart the process from the context file</p>
<pre><code>(node) cr_restart --no-restore-pid /tmp/test.context
</code></pre>
<p>The MATLAB process has been restarted</p>
<pre><code>(node) ps aux | grep MATLAB
</code></pre>
<h3 id="oar-integration">OAR integration</h3>
<p>Checkpointing is supported by OAR, by combining several features:</p>
<ul>
<li><strong>besteffort</strong> jobs: described in the previous exercise</li>
<li><strong>idempotent</strong> jobs: if your processus returns an exit code equal to 99, your job will be resubmitted with the same parameters ;</li>
<li><strong>checkpoint parameter</strong>: enable the checkpointing mechanism, specifies the time in seconds before sending a signal to the first processus of the job ;</li>
<li><strong>signal parameter</strong>: specify which signal to use when checkpointing (default is SIGUSR2).</li>
</ul>
<p>Let's start a long Matlab program with the launcher <code>launcher_checkpoint_restart.sh</code> which uses all these features.</p>
<p>First in <code>$WORK/PS6/launcher-scripts/bash/besteffort/launcher_checkpoint_restart.sh</code>, modify the variable <code>TASK</code> with your program:</p>
<pre><code>TASK="matlab -nojvm -nodisplay -nosplash -r run('$WORK/PS6/tutorials/advanced/advanced_workflows/scripts/test.m');exit;"
</code></pre>
<p>In the "Job settings" section, load the Matlab module by adding this line:</p>
<pre><code>module load base/MATLAB
</code></pre>
<p>Submit your job with this command</p>
<pre><code>oarsub --checkpoint 30 --signal 12 -l walltime=00:02:00 -t besteffort -t idempotent $WORK/PS6/launcher-scripts/bash/besteffort/launcher_checkpoint_restart.sh
</code></pre>
<p>Look at the OAR output in the stdout file and monitor the running jobs with oarstat.</p>
<p>Note that BLCR restore the full context of the job, including the file descriptors.
Therefore, the output of MATLAB is always sent to the stdout file of the initial job.</p>
<h1 id="please-clean-your-files">Please, clean your files</h1>
<pre><code>cd $WORK
rm -rf PS6
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../advanced_scheduling/" class="btn btn-neutral float-right" title="Advanced scheduling with SLURM">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../Spark/" class="btn btn-neutral" title="Big Data Application Over Apache Spark"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../../Spark/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../advanced_scheduling/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
